---
title: "hackhack"
author: "Sonia Xu"
date: "September 23, 2017"
output: html_document
---

#Read in the dataset
```{r setup, include=FALSE}
library(dplyr)
box <- read.csv("Player_Boxscores.csv")

#obtained this from basketball-reference.com

nbox <- box %>% group_by(Season) %>% mutate(lg_AST = mean(Assists), lg_FG = mean(Field_Goals), lg_ORB = mean(Offensive_Rebounds), lg_FT = mean(Free_Throws), lg_PTS = mean(Points), lg_FGA = mean(Field_Goals_Attempted), lg_TOV = mean(Turnovers), lg_FTA = mean(Free_Throws_Attempted), lg_TRB = mean(Rebounds), lg_PF = mean(Personal_Fouls))#splitting the data into league averages

nbox <- nbox %>% group_by(Season, Team_id) %>% mutate(team_AST = mean(Assists), team_FG = mean(Field_Goals)) #team averages
#nbox <- nbox %>% group_by(Season, Person_id) %>% mutate(Free_Throws = sum(Free_Throws), Free_Throws_Attempted = sum(Free_Throws_Attempted, Assists = sum(Assists), )
attach(nbox)

# PER formula
factor = (2 / 3) - (0.5 * (lg_AST / lg_FG)) / (2 * (lg_FG / lg_FT))
VOP    = lg_PTS / (lg_FGA - lg_ORB + lg_TOV + 0.44 * lg_FTA)
DRB   = (lg_TRB - lg_ORB) / lg_TRB

PER = ((1 / (Min_Played+1)) *
     ( Three_Pointers +
     + (2/3) * Assists
     + (2 - factor * (team_AST / team_FG)) * Field_Goals
     + (Free_Throws *0.5 * (1 + (1 - (team_AST / team_FG)) + (2/3) * (team_AST / team_FG)))
     - VOP * Turnovers
     - VOP * DRB * (Field_Goals_Attempted - Field_Goals)
     - VOP * 0.44 * (0.44 + (0.56 * DRB)) * (Free_Throws_Attempted - Free_Throws)
     + VOP * (1 - DRB) * (Rebounds - Offensive_Rebounds)
     + VOP * DRB * Offensive_Rebounds
     + VOP * Steals
     + VOP * DRB * Blocked_Shots
     - Personal_Fouls * ((lg_FT / lg_PF) - 0.44 * (lg_FTA / lg_PF) * VOP)))


# WS Formula
pts_produced <- 0

off_poss <- 0 #individual possessions, not team possessions while player was on court

marg_offense <- pts_produced - 0.92*lg_pts_per_poss*off_poss

tm_pace <- poss/min
lg_pace <- poss/min

marg_pts_per_win <- 0.32*lg_pts_per_game*(tm_pace/lg_pace)

o_win_shares <- marg_offense/marge_pts_per_win

d_pts <- 0

d_poss <- 0 #opposing team possessions while player was on court

d_rtg <- d_pts/d_poss

marg_def <- player_mins/tm_mins * tm_def_poss * ((108 * lg_pts_per_poss) - (d_rtg/100))

d_win_shares <- marg_def/marg_pts_per_win

win_shares <- o_win_shares + d_win_shares

##combine the two
detach(nbox)

nbox$PER <- PER
```